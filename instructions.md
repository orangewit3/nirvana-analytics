# project overview
You are building a personal health analytics webapplication. Given some user data (like height, weight, temperature, blood pressure, etc.) and a blood report you will create a series of health markers (overall health score, risk of diabetes, etc.) along with a detailed report for the user to download.

You will be using NextJS 14, shadcn, tailwind, Lucid icon and openAI

# Core functionalities
1. User health questionnaire form with body weight, height, temperature and a pdf of latest blood report. 
    1. Age parameter collected from a simple numerical input box
    2. Body weight parameter collected from a simple numerical input box with an option to change the units in a dropdown
    3. Temperature parameter collected from a simple numerical input box with an option to change the units in a dropdown
    4. Upload button that only accepts pdf for the blood report, the pdf-parser function is used to convert the pdf data to text
    5. Flashy button that says "What's my health score?", after selection the page changes. All data is stored as HealthDataInputSchema object and is cached for further processing
2. Process and display health scores for user based on input questionnaire data
    1. Input the HealthDataInputSchema object into an OpenAI structured output API to receive a structured output of user health score analysis (HealthAnalysisSchema)
3. Add the health score parameters each into a widgets
    1. For each of the HealthAnalysisSchema parameters create a widget with a horizontal scale that shows the severity of the illness based on the HealthScoreCategory
    2. Each widget has a information icon, when the user hovers over it they can get an summary explanation of why they received that score
4. Create a button that will output the full health report, this will be generated by an openAI model

# Doc

## Documentation of the health input data schema
```ts
// Define the schema for health data input
export const HealthDataInputSchema = z.object({
  patientId: z.string().min(1, "Patient ID is required"),
  age: z.number().min(0, "Age cannot be negative"),
  height: z.number().min(0, "Height cannot be negative"), // in cm
  weight: z.number().min(0, "Weight cannot be negative"), // in kg
  bloodReportText: z.string().min(1, "Blood report text is required"),
  createdAt: z.date().default(() => new Date()),
});
```


## Documentation of how to use the pdf parser to extract the text from the pdf

```ts
// pdf parser logic
interface PdfParseOptions {
  maxPages?: number;
}

interface HealthReportData {
  text: string;
  numPages: number;
  metadata: {
    title?: string;
    author?: string;
    creationDate?: string;
  };
}

/**
 * Extracts text content from a PDF health report buffer
 * @param input - PDF file as Buffer
 * @param options - Parsing options
 * @returns Promise containing the extracted text and metadata
 */
export async function parseHealthReport(
  input: Buffer,
  options: PdfParseOptions = {}
): Promise<HealthReportData> {
  try {
    const parseOptions = {
      max: options.maxPages || 0,
    };

    const data = await pdf(input, parseOptions);

    return {
      text: data.text,
      numPages: data.numpages,
      metadata: {
        title: data.metadata?.title || "N/A",
        author: data.metadata?.author || "N/A",
        creationDate: data.metadata?.creationDate || "N/A",
      },
    };
  } catch (error) {
    throw new Error(`Failed to parse PDF: ${(error as Error).message}`);
  }
}

// EXAMPLE USAGE:
// If you're using it in a React component or similar
async function handleFileUpload(event: React.ChangeEvent<HTMLInputElement>) {
  const file = event.target.files?.[0];
  if (!file) return;
  
  try {
    const result = await parseHealthReport(file, {
      preserveFormatting: true
    });
    console.log('Extracted text:', result.text);
  } catch (error) {
    console.error('Error parsing PDF:', error);
  }
}

// If you're using it with FormData in an API route
async function handleFormSubmission(formData: FormData) {
  const file = formData.get('pdfFile') as File;
  if (!file) return;
  
  const result = await parseHealthReport(file);
  return result;
}

// If you're working directly with a Buffer (e.g., in an API route)
async function handleBufferUpload(buffer: Buffer) {
  const result = await parseHealthReport(buffer);
  return result;
} '
```

## Documentation of how to use the openAI structured output API for health score analysis

```ts
// Zod schema for health score category
const HealthScoreCategory = z.object({
  score: z.number().min(0).max(10),
  explanation: z.string()
});

// Zod schema for health analysis
const HealthAnalysisSchema = z.object({
  overallHealthScore: HealthScoreCategory,
  cholesterolLevels: HealthScoreCategory,
  diabetesRisk: HealthScoreCategory,
  fattyLiverRisk: HealthScoreCategory,
  hypertensionRisk: HealthScoreCategory,
});

// Define the schema for health data input
export const HealthDataInputSchema = z.object({
  patientId: z.string().min(1, "Patient ID is required"),
  age: z.number().min(0, "Age cannot be negative"),
  height: z.number().min(0, "Height cannot be negative"), // in cm
  weight: z.number().min(0, "Weight cannot be negative"), // in kg
  bloodReportText: z.string().min(1, "Blood report text is required"),
  createdAt: z.date().default(() => new Date()),
});

// Export types derived from the Zod schemas
export type HealthScoreAnalysis = z.infer<typeof HealthAnalysisSchema>;
export type HealthDataInput = z.infer<typeof HealthDataInputSchema>;

// Generate analysis prompt
function generateAnalysisPrompt(params: HealthDataInput): string {
    return `
  Analyze the following health data and blood report to provide a detailed health score analysis. Score each category from 0 to 10 (where 0 is extremely bad and 10 is the best possible score) and provide explanations for each score.
  
  Patient Information:
  - Age: ${params.age} years
  - Height: ${params.height} cm
  - Weight: ${params.weight} kg
  - BMI: ${(params.weight / Math.pow(params.height / 100, 2)).toFixed(1)}
  
  Blood Report Data:
  ${params.bloodReportText}
  
  ### Instructions:
  1. Respond **strictly in JSON format**. Do not include any extra text or commentary outside the JSON.
  2. All scores must be numbers between 0 and 10.
  3. Each explanation should be a brief sentence (1-2 lines) summarizing the reasoning behind the score.
  
  ### JSON Response Example:
  {
    "overallHealthScore": {
      "score": 8,
      "explanation": "The patient has a healthy BMI and normal blood values, indicating good overall health."
    },
    "cholesterolLevels": {
      "score": 5,
      "explanation": "Total cholesterol is slightly elevated, requiring attention to diet and exercise."
    },
    "diabetesRisk": {
      "score": 6,
      "explanation": "HbA1c levels are borderline, indicating a moderate risk of diabetes."
    },
    "fattyLiverRisk": {
      "score": 3,
      "explanation": "Elevated ALT and AST levels suggest a significant risk of fatty liver disease."
    },
    "hypertensionRisk": {
      "score": 4,
      "explanation": "Sodium and LDL levels are elevated, contributing to a higher risk of hypertension."
    }
  }
  `;
  }

// Updated analysis function using OpenAI API format
export async function analyzeHealthData(
  healthData: HealthDataInput,
  openaiApiKey: string
): Promise<HealthScoreAnalysis> {
  // Validate input data using the schema
  const validatedData = HealthDataInputSchema.parse(healthData);
  
  const openai = new OpenAI({
    apiKey: openaiApiKey,
  });

  try {
    const completion = await openai.chat.completions.create({
      model: "gpt-4o",
      messages: [
        {
          role: "system",
          content: "You are a medical analysis AI that provides structured health score analysis based on health data and blood report parameters. Provide accurate, evidence-based assessments that take into account all patient data including age, BMI, and blood report values. The response must strictly follow the given JSON schema",
        },
        {
          role: "user",
          content: generateAnalysisPrompt(validatedData),
        },
      ],
      response_format:  { type: "json_object" },
      temperature: 0.5,
    });
    
    // Parse the JSON response
    const responseText = completion.choices[0]?.message?.content;
    if (!responseText) {
      throw new Error("Empty response received from OpenAI.");
    }

    const parsedResponse = JSON.parse(responseText);

    // Validate the response against the Zod schema
    const validatedResponse = HealthAnalysisSchema.parse(parsedResponse);
    return validatedResponse;

  } catch (error) {
    console.error('Error in health data analysis:', error);
    throw error;
  }
} 

```


# Current file structure
nirvana-analytics/
├── README.md
├── app
│   ├── favicon.ico
│   ├── fonts
│   ├── globals.css
│   ├── layout.tsx
│   └── page.tsx
├── components
│   └── ui
├── components.json
├── instructions
│   └── instructions.md
├── lib
│   └── utils.ts
├── next-env.d.ts
├── next.config.mjs
├── package-lock.json
├── package.json
├── postcss.config.mjs
├── tailwind.config.ts
└── tsconfig.json
